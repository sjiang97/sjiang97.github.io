<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Build Cloudflare worker with endpoint | Shaokang&#39;s Blog</title><meta name="keywords" content="cloudflare worker, Blog"><link rel="alternate" href="/atom.xml" title="Shaokang's Blog"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css"><link href="/css/table.css" type="text/css" rel="stylesheet" media="screen,projection"><link href="https://cdn.bootcss.com/KaTeX/0.7.1/katex.min.css" rel="stylesheet"><link rel="stylesheet" href="/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script><link rel="alternate" href="/atom.xml" title="Shaokang's Blog" type="application/atom+xml"></head><body><div class="cover-wrapper"><cover class="cover post half"><h1 class="title">Shaokang's Blog</h1><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="search"> <i class="icon fas fa-search fa-fw"></i></form></div><div class="menu navgation"><ul class="h-list"><li><a class="nav home" href="/" id="home"><i class="fas fa-rss fa-fw"></i>&nbsp;Recent</a></li><li><a class="nav home" href="/projects/" id="projects"><i class="fas fa-code-branch fa-fw"></i>&nbsp;Projects</a></li><li><a class="nav home" href="/about/" rel="nofollow" id="about"><i class="fas fa-info-circle fa-fw"></i>&nbsp;About</a></li></ul></div></cover><header class="l_header material"><div id="loading-bar-wrapper"><div id="loading-bar" class="material"></div></div><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/">Shaokang's Blog</a><div class="menu navgation"><ul class="h-list"><li><a class="nav flat-box" href="/" id="home"><i class="fas fa-grin fa-fw"></i>&nbsp;Recent</a></li><li><a class="nav flat-box" href="/categories/" rel="nofollow" id="categories"><i class="fas fa-folder-open fa-fw"></i>&nbsp;Category</a></li><li><a class="nav flat-box" href="/tags/" rel="nofollow" id="tags"><i class="fas fa-hashtag fa-fw"></i>&nbsp;Tags</a></li><li><a class="nav flat-box" href="/archives/" rel="nofollow" id="archives"><i class="fas fa-archive fa-fw"></i>&nbsp;Archive</a></li></ul></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <i class="icon fas fa-search fa-fw"></i></form></div><ul class="switcher h-list"><li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li><li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo flat-box"></a><ul class="switcher h-list"><li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li><li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li></ul></div></div></header><aside class="menu-phone"><header><nav class="menu navgation"><ul><li><a class="nav flat-box" href="/" id="home"><i class="fas fa-clock fa-fw"></i>&nbsp;Recent</a></li><li><a class="nav flat-box" href="/archives/" rel="nofollow" id="archives"><i class="fas fa-archive fa-fw"></i>&nbsp;Archive</a></li><li><a class="nav flat-box" href="/projects/" id="projects"><i class="fas fa-code-branch fa-fw"></i>&nbsp;Project</a></li><li><a class="nav flat-box" href="/categories/" rel="nofollow" id="categories"><i class="fas fa-folder-open fa-fw"></i>&nbsp;Category</a></li><li><a class="nav flat-box" href="/tags/" rel="nofollow" id="tags"><i class="fas fa-hashtag fa-fw"></i>&nbsp;Tags</a></li><li><a class="nav flat-box" href="/about/" rel="nofollow" id="about"><i class="fas fa-info-circle fa-fw"></i>&nbsp;About</a></li></ul></nav></header></aside><script>setLoadingBarProgress(40)</script></div><div class="l_body"><div class="body-wrapper"><div class="l_main"><article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><div class="meta" id="header-meta"><h1 class="title"><a href="/2020/projects/Build-Cloudflare-worker-with-endpoint/">Build Cloudflare worker with endpoint</a></h1><div class="new-meta-box"><div class="new-meta-item author"><a href="https://shaokang.ga" rel="nofollow"><i class="fas fa-user" aria-hidden="true"></i><p>Shaokang Jiang</p></a></div><div class="new-meta-item date"><a class="notlink"><i class="fas fa-calendar-alt" aria-hidden="true"></i><p>12/05/2020</p></a></div><div class="new-meta-item category"><a href="/categories/website/Cloudflare-Worker/" rel="nofollow"><i class="fas fa-folder-open" aria-hidden="true"></i><p>website&nbsp;/&nbsp;Cloudflare Worker</p></a></div></div><hr></div></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p>Cloudflare worker is a serverless application based on v9 engine. The structure is a little bit different than the Node.js. Endpoints is familiar to most people in developing. But this seems to be different on worker. And it is useful especially when different services is running in the same worker. This one will show how to integrate traditional endpoint feature on cloudflare worker to likely have a fake endpoint handler. This is a sub-project of Financial website.</p><a id="more"></a><h3 id="end-points"><a class="markdownIt-Anchor" href="#end-points"></a> End-points:</h3><p>Three end points is in this sample, they are arranged in three different purpose.</p><blockquote><p>Check the <a href="https://shaokang.ga/2021/AES-Encrypt-and-Decrypt-on-Cloudflare-worker/">AES Encrypt and Decrypt on Cloudflare worker</a> to see the encryption and decryption methods using in <code>/authenticate</code> and <code>/generate</code>, which is based on <code>AES-GCM</code></p></blockquote><p><code>/authenticate</code> return a password if the information, like <code>token</code> and <code>quizepartcode</code> matched with our record. Otherwise, return false;</p><p><code>/generate</code> Generate a user learning progress, will need quizpartcode in the body.</p><p><code>/sendmail</code> with a password as authentication to send email via sendgrid from <a href="mailto:admin@capitaltwo.ga" target="_blank" rel="noopener">admin@capitaltwo.ga</a>. This method is not enabled as sendgrid has been blocked by a lot of client.</p><h3 id="initial-handling"><a class="markdownIt-Anchor" href="#initial-handling"></a> Initial Handling</h3><p>In each fetch request to worker, there will be a request with content pass to the worker, usually and officially returning method is</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addEventListener(<span class="string">'fetch'</span>, event =&gt; &#123;</span><br><span class="line">  event.respondWith(handleRequest(event.request))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="reroute-request"><a class="markdownIt-Anchor" href="#reroute-request"></a> Reroute Request</h3><p>Even though Worker is just JavaScript running on v8, we could just create a function to reroute each request based on the address user is requesting, like</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(endpoint, fn) =&gt; &#123;</span><br><span class="line">      url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">      <span class="keyword">if</span> (url.pathname === endpoint &amp;&amp; request.method === <span class="string">"POST"</span>)</span><br><span class="line">        <span class="keyword">return</span> fn(request);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>In javascript, functions could wrapped using a variable, so, it is possible to create an object to contain everything, like</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = &#123;</span><br><span class="line">  <span class="keyword">get</span>: (endpoint, fn) =&gt; &#123; <span class="comment">// for get request</span></span><br><span class="line">    url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">    <span class="keyword">if</span> (url.pathname === endpoint &amp;&amp; request.method === <span class="string">"GET"</span>)</span><br><span class="line">      <span class="keyword">return</span> fn(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  post: <span class="function">(<span class="params">endpoint, fn</span>) =&gt;</span> &#123;</span><br><span class="line">    url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">    <span class="keyword">if</span> (url.pathname === endpoint &amp;&amp; request.method === <span class="string">"POST"</span>)</span><br><span class="line">      <span class="keyword">return</span> fn(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="return-a-response"><a class="markdownIt-Anchor" href="#return-a-response"></a> Return a <code>Response</code></h3><p>Whenever needed in <code>handleRequest</code>, it is as easy as calling <code>app.post(&quot;/endPoint&quot;, functionName)</code>. And if null is returned, check next endpoint, otherwise the correct function will be called and executed. The reroute function like this:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * reroute</span></span><br><span class="line"><span class="comment"> * @param &#123;Request&#125; request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = &#123;</span><br><span class="line">    <span class="keyword">get</span>: (endpoint, fn) =&gt; &#123; <span class="comment">// for get request</span></span><br><span class="line">      url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">      <span class="keyword">if</span> (url.pathname === endpoint &amp;&amp; request.method === <span class="string">"GET"</span>)</span><br><span class="line">        <span class="keyword">return</span> fn(request);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    post: <span class="function">(<span class="params">endpoint, fn</span>) =&gt;</span> &#123;</span><br><span class="line">      url = <span class="keyword">new</span> URL(request.url);</span><br><span class="line">      <span class="keyword">if</span> (url.pathname === endpoint &amp;&amp; request.method === <span class="string">"POST"</span>)</span><br><span class="line">        <span class="keyword">return</span> fn(request);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">let</span> lastResponse = app.post(<span class="string">"/authenticate"</span>, handleAuthen)</span><br><span class="line">  <span class="keyword">if</span> (lastResponse) &#123;</span><br><span class="line">    <span class="keyword">return</span> lastResponse;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lastResponse = app.post(<span class="string">"/generate"</span>, handleGen)</span><br><span class="line">  <span class="keyword">if</span> (lastResponse) &#123;</span><br><span class="line">    <span class="keyword">return</span> lastResponse;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lastResponse = app.post(<span class="string">"/sendmail"</span>, sendMail)</span><br><span class="line">  <span class="keyword">if</span> (lastResponse) &#123;</span><br><span class="line">    <span class="keyword">return</span> lastResponse;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'&#123;"message":"Hello! Default is touched."&#125;'</span>, notFoundHead);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>notFoundHead</code> is the head content created as a js Object, like</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> notFoundHead = &#123;</span><br><span class="line">  status: <span class="string">'404'</span>,</span><br><span class="line">  statusText: <span class="string">'NOT FOUND'</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>,</span><br><span class="line">    <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'https://capitaltwo.ga'</span>,</span><br><span class="line">    <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'GET,POST,PUT,DELETE'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Caution:</strong> Without a head containing the <code>Access-Control-Allow-Origin</code>, CORS error will be posted. Cloudflare worker seems to be strict on this thing. If any error or exception happened without any <code>try</code> … <code>catch</code>, CORS will also be given. So, to be convenient in debugging, a good practice is always to return a Not found header when error happened in some cases.</p><p>If method other than <code>GET</code> is used, <code>Access-Control-Allow-Methods</code> should also be used. Otherwise, CORS error would also happen.</p><p>And when posting fetch request, do not append header in this example because it is not appropriately handled and it might have problem in this case.</p></blockquote><p>One function in the sample is <code>handleAuthen</code>, and one another is <code>handleGen</code>. Those two are normal functions and just return a new <code>Response</code> at last would be fine. Like:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; request </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">handleAuthen</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = <span class="keyword">await</span> request.json();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">  XXX: XXX&#125;), Header)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="visiting-data-part-in-request"><a class="markdownIt-Anchor" href="#visiting-data-part-in-request"></a> Visiting Data part in request</h3><p>Because the data section of the request is a <code>Promise</code> object, it has to be called with <code>await</code> and <code>.json()</code> in order to visit it. Like: <code>var data = await request.json();</code>.</p><h3 id="sendmail-through-sendgrid"><a class="markdownIt-Anchor" href="#sendmail-through-sendgrid"></a> SendMail through sendgrid</h3><p>In the real case, sending a mail to the user is general. And sometimes, we have certain sensitive data that should not be promoted to client. This could be implemented through the following method in worker and called in client like this. That is what the third endpoint <code>/sendmail</code> is doing. like:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; request </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMail</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="keyword">await</span> fetch(<span class="string">"https://api.sendgrid.com/v3/mail/send"</span>, &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Authorization"</span>: <span class="string">"Bearer SG.P_Xcg7PmRgirESQCCXXX...Tm1xo7tz5w"</span>,</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      <span class="string">"personalizations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"to"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">"email"</span>: <span class="string">"admin@capitaltwo.ga"</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"from"</span>: &#123;</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"admin@capitaltwo.ga"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"subject"</span>: <span class="string">"Sending with SendGrid is Fun"</span>,</span><br><span class="line">      <span class="string">"content"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"type"</span>: <span class="string">"text/plain"</span>,</span><br><span class="line">          <span class="string">"value"</span>: <span class="string">"and easy to do anywhere, even with cURL"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (a.ok) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'&#123;"message":"successfully sent"&#125;'</span>, normalHeader)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> k = <span class="keyword">await</span> a.json();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="built_in">JSON</span>.stringify(k), normalHeader)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Caution:</strong> <code>sendgrid</code> will not return anything if the response status is ok, which could be checked with <code>a.ok</code> in the previous sample. If wrong, a data will be returned and could be decoded to json Object</p></blockquote><h3 id="run"><a class="markdownIt-Anchor" href="#run"></a> Run</h3><p>In order to run and test locally, you need to install <a href="https://developers.cloudflare.com/workers/cli-wrangler/install-update" target="_blank" rel="noopener">Cloudflare Worker Local client</a> first.</p><p>Then do:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrangler dev</span><br></pre></td></tr></table></figure></div><section class="meta" id="footer-meta"><hr><div class="new-meta-box"><div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-01-15T17:29:35-06:00"><a class="notlink"><i class="fas fa-clock" aria-hidden="true"></i><p>last updated at Jan 15, 2021</p></a></div><div class="new-meta-item meta-tags"><a class="tag" href="/tags/JS/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>JS</p></a></div></div></section><div class="prev-next"><section class="prev"><span class="art-item-left"><h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;Previous</h6><h4><a href="/2020/a-dialog-flow-app/" rel="prev" title="A dialog flow app">A dialog flow app</a></h4><h6 class="tags"><a class="tag" href="/tags/Dialogflow/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Dialogflow</a></h6></span></section><section class="next"><span class="art-item-right" aria-hidden="true"><h6>Next&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6><h4><a href="/2020/Financial-organization-phone-application/" rel="prev" title="Financial organization phone app - stage 1">Financial organization phone app - stage 1</a></h4><h6 class="tags"><a class="tag" href="/tags/Expo/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Expo</a> <a class="tag" href="/tags/MIP/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>MIP</a></h6></span></section></div></section></article><article class="post white-box comments"><section class="article typo"><h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;Comments</h4><section id="comments"><div id="valine_container" class="valine_thread"><i class="fas fa-spinner fa-spin fa-fw"></i></div></section></section></article><script>window.subData={title:"Build Cloudflare worker with endpoint",tools:!0}</script></div><aside class="l_side"><section class="widget toc-wrapper"><header class="material"><div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;TOC</div><div class="wrapper"><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div></header><div class="content material"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#end-points"><span class="toc-text">End-points:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#initial-handling"><span class="toc-text">Initial Handling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reroute-request"><span class="toc-text">Reroute Request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return-a-response"><span class="toc-text">Return a Response</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visiting-data-part-in-request"><span class="toc-text">Visiting Data part in request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sendmail-through-sendgrid"><span class="toc-text">SendMail through sendgrid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#run"><span class="toc-text">Run</span></a></li></ol></div></section><section class="widget category"><header class="material"><div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Categories</div><a class="rightBtn" rel="nofollow" href="/categories/" title="categories/"><i class="fas fa-expand-arrows-alt fa-fw"></i></a></header><div class="content material"><ul class="entry"><li><a class="flat-box" title="/categories/Cryptocurrency-Application/" href="/categories/Cryptocurrency-Application/"><div class="name">Cryptocurrency Application</div><div class="badge">(4)</div></a></li><li><a class="flat-box child" title="/categories/Cryptocurrency-Application/Bitcoin/" href="/categories/Cryptocurrency-Application/Bitcoin/"><div class="name">Bitcoin</div><div class="badge">(1)</div></a></li><li><a class="flat-box child" title="/categories/Cryptocurrency-Application/EOSIO/" href="/categories/Cryptocurrency-Application/EOSIO/"><div class="name">EOSIO</div><div class="badge">(3)</div></a></li><li><a class="flat-box" title="/categories/Expo/" href="/categories/Expo/"><div class="name">Expo</div><div class="badge">(4)</div></a></li><li><a class="flat-box" title="/categories/Programs/" href="/categories/Programs/"><div class="name">Programs</div><div class="badge">(5)</div></a></li><li><a class="flat-box child" title="/categories/Programs/Coursework/" href="/categories/Programs/Coursework/"><div class="name">Coursework</div><div class="badge">(3)</div></a></li><li><a class="flat-box child" title="/categories/Programs/tools/" href="/categories/Programs/tools/"><div class="name">tools</div><div class="badge">(2)</div></a></li><li><a class="flat-box" title="/categories/optimization/" href="/categories/optimization/"><div class="name">optimization</div><div class="badge">(4)</div></a></li><li><a class="flat-box" title="/categories/website/" href="/categories/website/"><div class="name">website</div><div class="badge">(9)</div></a></li><li><a class="flat-box child" title="/categories/website/Cloudflare-Worker/" href="/categories/website/Cloudflare-Worker/"><div class="name">Cloudflare Worker</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="/categories/website/Hexo/" href="/categories/website/Hexo/"><div class="name">Hexo</div><div class="badge">(2)</div></a></li><li><a class="flat-box child" title="/categories/website/JS/" href="/categories/website/JS/"><div class="name">JS</div><div class="badge">(1)</div></a></li></ul></div></section><section class="widget tagcloud"><header class="material"><div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Hot Tags</div><a class="rightBtn" rel="nofollow" href="/tags/" title="tags/"><i class="fas fa-expand-arrows-alt fa-fw"></i></a></header><div class="content material"><a href="/tags/AES/" style="font-size:14px;color:#999">AES</a> <a href="/tags/Bitcoin/" style="font-size:14px;color:#999">Bitcoin</a> <a href="/tags/Dialogflow/" style="font-size:14px;color:#999">Dialogflow</a> <a href="/tags/Expo/" style="font-size:22px;color:#636363">Expo</a> <a href="/tags/GAMS/" style="font-size:16px;color:#8b8b8b">GAMS</a> <a href="/tags/HTML/" style="font-size:18px;color:#7e7e7e">HTML</a> <a href="/tags/JFoenix/" style="font-size:14px;color:#999">JFoenix</a> <a href="/tags/JS/" style="font-size:20px;color:#707070">JS</a> <a href="/tags/Java/" style="font-size:16px;color:#8b8b8b">Java</a> <a href="/tags/JavaFX/" style="font-size:16px;color:#8b8b8b">JavaFX</a> <a href="/tags/MIP/" style="font-size:24px;color:#555">MIP</a> <a href="/tags/Nlp-js/" style="font-size:20px;color:#707070">Nlp.js</a> <a href="/tags/Notes/" style="font-size:14px;color:#999">Notes</a> <a href="/tags/SQL/" style="font-size:16px;color:#8b8b8b">SQL</a> <a href="/tags/Self-learning/" style="font-size:14px;color:#999">Self learning</a> <a href="/tags/Website/" style="font-size:20px;color:#707070">Website</a> <a href="/tags/choco-solver/" style="font-size:14px;color:#999">choco-solver</a> <a href="/tags/ejs/" style="font-size:16px;color:#8b8b8b">ejs</a> <a href="/tags/eos/" style="font-size:18px;color:#7e7e7e">eos</a> <a href="/tags/eos-cdt/" style="font-size:18px;color:#7e7e7e">eos.cdt</a> <a href="/tags/eosio-contracts/" style="font-size:18px;color:#7e7e7e">eosio.contracts</a> <a href="/tags/jsLpsolver/" style="font-size:14px;color:#999">jsLpsolver</a></div></section><section class="widget related_posts"><header class="material"><div><i class="fas fa-bookmark fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;Related Posts</div></header><div class="content material"><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2020/Simple-autocorrect-with-Bigram/" title="Simple autocorrect with Bigram" rel="bookmark">Simple autocorrect with Bigram</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2020/projects/Modified-simulator/" title="Modified traffic simulator" rel="bookmark">Modified traffic simulator</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2020/projects/Publication-of-Financial-website/" title="Publication for Financial website" rel="bookmark">Publication for Financial website</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2020/Capstone-prooject-design-specification-v0-1/" title="Capstone project design specification" rel="bookmark">Capstone project design specification</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2021/AES-Encrypt-and-Decrypt-on-Cloudflare-worker/" title="AES Encrypt and Decrypt on Cloudflare worker" rel="bookmark">AES Encrypt and Decrypt on Cloudflare worker</a></h3></div></li></ul></div></section></aside><footer id="footer" class="clearfix"><div class="footer"></div><br><div class="social-wrapper"><a href="mailto:huangsk100@gmail.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://github.com/ShaokangJiang" class="social fab fa-github flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a> <a href="https://github.com/sjiang97" class="social fab fa-github flat-btn" target="_blank" rel="external nofollow noopener noreferrer"></a></div><br><div><p>Powered by <a href="https://hexo.io/">Hexo</a>. Use <a href="https://xaoxuu.com/wiki/material-x/">Material-X</a> as theme.</p></div></footer><script>setLoadingBarProgress(80)</script><script>setLoadingBarProgress(60)</script></div><a class="s-top fas fa-arrow-up fa-fw" href="javascript:void(0)"></a></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script><script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script><script type="text/javascript">$((function(){0!==$(".reveal").length&&ScrollReveal({distance:0}).reveal(".reveal")}))</script><script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script><script type="text/javascript">$((function(){Waves.attach(".flat-btn",["waves-button"]),Waves.attach(".float-btn",["waves-button","waves-float"]),Waves.attach(".float-btn-light",["waves-button","waves-float","waves-light"]),Waves.attach(".flat-box",["waves-block"]),Waves.attach(".float-box",["waves-block","waves-float"]),Waves.attach(".waves-image"),Waves.init()}))</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script type="text/javascript">$((function(){$(".cover").backstretch(["https://img.vim-cn.com/6d/a0c9e6f9efad8b731cb7376504bd10d79d2053.jpg"],{duration:"6000",fade:"2500"})}))</script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-valine@1.3.4/js/valine.min.js"></script><script>var GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter((function(i){return GUEST_INFO.indexOf(i)>-1})),notify=!1,verify=!1,valine=new Valine;valine.init({el:"#valine_container",notify:notify,verify:verify,guest_info:guest_info,appId:"g0v2qyGEhGys4wGpCLsKkerW-gzGzoHsz",appKey:"Sceumpu0A14EiY5RR3HtsCFx",placeholder:"",pageSize:"10",avatar:"mp",lang:"en",highlight:"false"})</script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.4.19/js/app.js"></script><script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.4.19/js/search.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>let COPY_SUCCESS="Copied",COPY_FAILURE="Copy failed";window,document,function(){$(".highlight .code pre").before('<button class="btn-copy" data-clipboard-snippet="">  <i class="fa fa-copy"></i><span>Copy</span></button>');var o=new ClipboardJS(".btn-copy",{target:function(o){return o.nextElementSibling}});o.on("success",(function(o){console.info("Action:",o.action),console.info("Text:",o.text),console.info("Trigger:",o.trigger),success_prompt(COPY_SUCCESS),o.clearSelection()})),o.on("error",(function(o){console.error("Action:",o.action),console.error("Trigger:",o.trigger),fail_prompt(COPY_FAILURE)}))}();var prompt=function(o,n,t){n=void 0===n?"alert-success":n,t=void 0===t?1500:1e3*t,$("<div>").appendTo("body").addClass("alert "+n).html(o).show().delay(t).fadeOut()},success_prompt=function(o,n){prompt(o,"alert-success",n)},fail_prompt=function(o,n){prompt(o,"alert-danger",n)},warning_prompt=function(o,n){prompt(o,"alert-warning",n)},info_prompt=function(o,n){prompt(o,"alert-info",n)}</script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>let LAZY_LOAD_IMAGE="";$(".article-entry").find("fancybox").find("img").each((function(){var t=document.createElement("a");$(t).attr("data-fancybox","gallery"),$(t).attr("href",$(this).attr("src")),LAZY_LOAD_IMAGE&&$(t).attr("href",$(this).attr("data-original")),$(this).wrap(t)}))</script><script>setLoadingBarProgress(100)</script></body></html>